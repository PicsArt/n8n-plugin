# GitLab CI/CD Pipeline for @picsart/n8n-nodes-picsart-apis
# This pipeline automatically builds, tests, and publishes to NPM

# Use Node.js 20 Docker image (matches package.json requirement)
image: node:20

# Define pipeline stages (run in order)
stages:
  - install      # Install dependencies
  - lint         # Check code quality
  - build        # Compile TypeScript
  - publish      # Publish to NPM
  - release      # Create GitLab release

# Cache dependencies for faster builds
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - .pnpm-store/

# Install pnpm before each job
before_script:
  - npm install -g pnpm
  - pnpm config set store-dir .pnpm-store

# ================================
# JOB 1: Install Dependencies
# ================================
install_dependencies:
  stage: install
  script:
    - pnpm install
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour
  only:
    - branches
    - tags
    - merge_requests

# ================================
# JOB 2: Lint Code
# ================================
lint:
  stage: lint
  script:
    - pnpm install
    - pnpm run lint
  only:
    - branches
    - merge_requests
    - tags

# ================================
# JOB 3: Format Check
# ================================
format_check:
  stage: lint
  script:
    - pnpm install
    - pnpm run format
    - |
      if [ -n "$(git status --porcelain)" ]; then
        echo "âŒ Code formatting issues detected. Run 'pnpm run format' locally."
        git diff
        exit 1
      fi
    - echo "âœ… Code formatting is correct."
  allow_failure: true
  only:
    - branches
    - merge_requests

# ================================
# JOB 4: Build Project
# ================================
build:
  stage: build
  script:
    - pnpm install
    - pnpm run build
    - echo "âœ… Build successful!"
    - ls -la dist/
  artifacts:
    paths:
      - dist/
    expire_in: 1 day
  only:
    - branches
    - tags
    - merge_requests

# ================================
# JOB 5: Publish to NPM (only on tags)
# ================================
publish_npm:
  stage: publish
  script:
    - echo "ğŸ“¦ Publishing @picsart/n8n-nodes-picsart-apis to NPM..."
    - pnpm install
    - if [ -z "$NPM_TOKEN" ]; then echo "âŒ ERROR NPM_TOKEN is not set!"; exit 1; fi
    - echo "âœ… NPM_TOKEN is set"
    - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
    - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
    - pnpm run build
    - npm pack --dry-run
    - npm whoami
    - npm publish --access public
    
    - echo "âœ… Successfully published to NPM!"
    - echo "ğŸ“¦ Package:" "@picsart/n8n-nodes-picsart-apis@${CI_COMMIT_TAG}"
    - echo "ğŸ”— View at:" "https://www.npmjs.com/package/@picsart/n8n-nodes-picsart-apis"
  rules:
    - if: $CI_COMMIT_TAG
      when: on_success

# ================================
# JOB 6: Create GitLab Release
# ================================
create_release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "ğŸ·ï¸ Creating GitLab release for $CI_COMMIT_TAG"
  release:
    tag_name: $CI_COMMIT_TAG
    name: 'Release $CI_COMMIT_TAG'
    description: |
      ## @picsart/n8n-nodes-picsart-apis $CI_COMMIT_TAG
      
      ### Installation
      ```bash
      npm install @picsart/n8n-nodes-picsart-apis
      ```
      
      ### What's New
      See [CHANGELOG.md](CHANGELOG.md) for details.
      
      ### Links
      - ğŸ“¦ [NPM Package](https://www.npmjs.com/package/@picsart/n8n-nodes-picsart-apis)
      - ğŸ“š [Documentation](README.md)
      - ğŸ› [Report Issues](https://gitlab.com/picsart/api-bu/plugins/n8n-nodes-picsart-apis/-/issues)
  rules:
    - if: $CI_COMMIT_TAG
      when: on_success

